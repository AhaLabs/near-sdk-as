"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ClassExporter = void 0;
const as_1 = require("visitor-as/as");
const visitor_as_1 = require("visitor-as");
const JSONBuilder_1 = require("./JSONBuilder");
const utils_1 = require("./utils");
const toString = visitor_as_1.utils.toString;
class ClassExporter extends visitor_as_1.ClassDecorator {
    constructor() {
        super(...arguments);
        this.sb = [];
    }
    get className() {
        return toString(ClassExporter.classSeen.name);
    }
    visitFieldDeclaration(node) {
        let orgName = node.name.text;
        let type = toString(node.type);
        if (node.is(as_1.CommonFlags.PUBLIC)) {
            node.flags = node.flags ^ as_1.CommonFlags.PUBLIC;
            node.flags = node.flags | as_1.CommonFlags.PRIVATE;
        }
        node.name.text = `__${orgName}`;
        let setter = `
  private set ${orgName}(${orgName}: ${type}) {
    __updated = true;
    this.${node.name.text} = ${orgName};
  }`;
        let getter = `
    private get ${orgName}(): ${type} {
      return this.${node.name.text};
    }`;
        let parent = ClassExporter.classSeen;
        let methods = [setter, getter].map(m => utils_1.SimpleParser.parseMethodDeclaration(m, parent));
        parent.members.push(...methods);
    }
    visitMethodDeclaration(node) {
        if (node.is(as_1.CommonFlags.SET) || node.is(as_1.CommonFlags.GET)) {
            throw new Error("Exported Singleton class cannot have properties. Found " + node.name.text);
        }
        let name = toString(node.name);
        let decorators = (node.decorators || []).map(toString);
        let returnType = toString(node.signature.returnType);
        let origParams = node.signature.parameters.map(visitor_as_1.utils.cloneNode);
        let parameters = origParams.map(param => {
            if (param.implicitFieldDeclaration) {
                param.name.text = param.name.text.substring(2);
            }
            return toString(param);
        });
        let pramNames = origParams.map((param) => {
            return toString(param.name);
        });
        let isInit = name === "constructor";
        let assertStr = isInit
            ? `assert(isNull(__contract), "contract is already initialized");`
            : `assert(!isNull(__contract), "contract is not initialized");`;
        let isVoid = returnType === "void";
        let body = isInit
            ? `__contract = new ${this.className}(${pramNames.join(", ")});`
            : `${!isVoid ? "let res =  " : ""}__contract.${name}(${pramNames.join(", ")});`;
        if (isInit) {
            name = "init";
            parameters = origParams.map((node) => `${toString(node.name)}: ${toString(node.type)}${node.initializer ? " = " + toString(node.initializer) : ""}`);
            returnType = "void";
        }
        if (isInit) {
            if (!decorators.some(decorator => decorator.includes("exportAs"))) {
                decorators.push(`@exportAs("new")`);
            }
        }
        this.sb.push(`${decorators.join("\n")}
      export function ${name}(${parameters.join(", ")}): ${returnType} {
  ${assertStr}
  ${body}
  ${isInit ? `__setState(__contract)` : "__updateState(__contract)"};
  ${isVoid || isInit ? "" : "return res"}
}`);
    }
    visitClassDeclaration(node) {
        if (JSONBuilder_1.isEntry(node) && node.is(as_1.CommonFlags.EXPORT)) {
            let name = toString(node.name);
            if (ClassExporter.classSeen) {
                throw new Error(`Cannot export class ${name}. ${ClassExporter.classSeen} already exported. `);
            }
            ClassExporter.classSeen = node;
            this.sb.push(`let __contract: ${name};
if (__checkState()) {
  __contract = __getState<${name}>();
}`);
            this.visit(node.members);
            node.flags = node.flags ^ as_1.CommonFlags.EXPORT;
            let newStatements = utils_1.SimpleParser.parseTopLevel(this.sb.join("\n")).map(n => {
                if (n instanceof as_1.FunctionDeclaration) {
                    n.flags = n.flags | as_1.CommonFlags.EXPORT;
                    n.flags = n.flags | as_1.CommonFlags.MODULE_EXPORT;
                }
                n.range = node.range;
                return n;
            });
            node.range.source.statements.push(...newStatements);
        }
    }
    get name() {
        return "nearBindgen";
    }
    static visit(source) {
        if (source.sourceKind != as_1.SourceKind.USER_ENTRY) {
            return;
        }
        let visitor = new ClassExporter();
        visitor.visit(source);
    }
}
exports.ClassExporter = ClassExporter;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2xhc3NFeHBvcnRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9jbGFzc0V4cG9ydGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLHNDQVF1QjtBQUN2QiwyQ0FBbUQ7QUFDbkQsK0NBQXdDO0FBQ3hDLG1DQUF1QztBQUV2QyxNQUFNLFFBQVEsR0FBRyxrQkFBSyxDQUFDLFFBQVEsQ0FBQztBQUVoQyxNQUFhLGFBQWMsU0FBUSwyQkFBYztJQUFqRDs7UUFDRSxPQUFFLEdBQWEsRUFBRSxDQUFDO0lBOEhwQixDQUFDO0lBM0hDLElBQUksU0FBUztRQUNYLE9BQU8sUUFBUSxDQUFDLGFBQWEsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDaEQsQ0FBQztJQUVELHFCQUFxQixDQUFDLElBQXNCO1FBQzFDLElBQUksT0FBTyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDO1FBQzdCLElBQUksSUFBSSxHQUFHLFFBQVEsQ0FBQyxJQUFJLENBQUMsSUFBSyxDQUFDLENBQUM7UUFDaEMsSUFBSSxJQUFJLENBQUMsRUFBRSxDQUFDLGdCQUFXLENBQUMsTUFBTSxDQUFDLEVBQUU7WUFDL0IsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsS0FBSyxHQUFHLGdCQUFXLENBQUMsTUFBTSxDQUFDO1lBQzdDLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssR0FBRyxnQkFBVyxDQUFDLE9BQU8sQ0FBQztTQUMvQztRQUNELElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxHQUFHLEtBQUssT0FBTyxFQUFFLENBQUM7UUFDaEMsSUFBSSxNQUFNLEdBQUc7Z0JBQ0QsT0FBTyxJQUFJLE9BQU8sS0FBSyxJQUFJOztXQUVoQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksTUFBTSxPQUFPO0lBQ2xDLENBQUE7UUFDQSxJQUFJLE1BQU0sR0FBRztrQkFDQyxPQUFPLE9BQU8sSUFBSTtvQkFDaEIs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ZWxkRGVjbGFyYXRpb24sXG4gIE1ldGhvZERlY2xhcmF0aW9uLFxuICBTb3VyY2UsXG4gIENvbW1vbkZsYWdzLFxuICBTb3VyY2VLaW5kLFxuICBGdW5jdGlvbkRlY2xhcmF0aW9uLFxufSBmcm9tIFwidmlzaXRvci1hcy9hc1wiO1xuaW1wb3J0IHsgdXRpbHMsIENsYXNzRGVjb3JhdG9yIH0gZnJvbSBcInZpc2l0b3ItYXNcIjtcbmltcG9ydCB7IGlzRW50cnkgfSBmcm9tIFwiLi9KU09OQnVpbGRlclwiO1xuaW1wb3J0IHsgU2ltcGxlUGFyc2VyIH0gZnJvbSBcIi4vdXRpbHNcIjtcblxuY29uc3QgdG9TdHJpbmcgPSB1dGlscy50b1N0cmluZztcblxuZXhwb3J0IGNsYXNzIENsYXNzRXhwb3J0ZXIgZXh0ZW5kcyBDbGFzc0RlY29yYXRvciB7XG4gIHNiOiBzdHJpbmdbXSA9IFtdO1xuICBzdGF0aWMgY2xhc3NTZWVuOiBDbGFzc0RlY2xhcmF0aW9uO1xuXG4gIGdldCBjbGFzc05hbWUoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdG9TdHJpbmcoQ2xhc3NFeHBvcnRlci5jbGFzc1NlZW4ubmFtZSk7XG4gIH1cblxuICB2aXNpdEZpZWxkRGVjbGFyYXRpb24obm9kZTogRmllbGREZWNsYXJhdGlvbik6IHZvaWQge1xuICAgIGxldCBvcmdOYW1lID0gbm9kZS5uYW1lLnRleHQ7XG4gICAgbGV0IHR5cGUgPSB0b1N0cmluZyhub2RlLnR5cGUhKTtcbiAgICBpZiAobm9kZS5pcyhDb21tb25GbGFncy5QVUJMSUMpKSB7XG4gICAgICBub2RlLmZsYWdzID0gbm9kZS5mbGFncyBeIENvbW1vbkZsYWdzLlBVQkxJQztcbiAgICAgIG5vZGUuZmxhZ3MgPSBub2RlLmZsYWdzIHwgQ29tbW9uRmxhZ3MuUFJJVkFURTtcbiAgICB9XG4gICAgbm9kZS5uYW1lLnRleHQgPSBgX18ke29yZ05hbWV9YDtcbiAgICBsZXQgc2V0dGVyID0gYFxuICBwcml2YXRlIHNldCAke29yZ05hbWV9KCR7b3JnTmFtZX06ICR7dHlwZX0pIHtcbiAgICBfX3VwZGF0ZWQgPSB0cnVlO1xuICAgIHRoaXMuJHtub2RlLm5hbWUudGV4dH0gPSAke29yZ05hbWV9O1xuICB9YFxuICAgIGxldCBnZXR0ZXIgPSBgXG4gICAgcHJpdmF0ZSBnZXQgJHtvcmdOYW1lfSgpOiAke3R5cGV9IHtcbiAgICAgIHJldHVybiB0aGlzLiR7bm9kZS5uYW1lLnRleHR9O1xuICAgIH1gXG4gICAgbGV0IHBhcmVudCA9IENsYXNzRXhwb3J0ZXIuY2xhc3NTZWVuO1xuICAgIGxldCBtZXRob2RzID0gW3NldHRlciwgZ2V0dGVyXS5tYXAoXG4gICAgICAgICAgICAgICAgICBtID0+IFNpbXBsZVBhcnNlci5wYXJzZU1ldGhvZERlY2xhcmF0aW9uKG0sIHBhcmVudCkpO1xuICAgIHBhcmVudC5tZW1iZXJzLnB1c2goLi4ubWV0aG9kcyk7XG4gIH1cblxuICB2aXNpdE1ldGhvZERlY2xhcmF0aW9uKG5vZGU6IE1ldGhvZERlY2xhcmF0aW9uKTogdm9pZCB7XG4gICAgaWYgKG5vZGUuaXMoQ29tbW9uRmxhZ3MuU0VUKSB8fCBub2RlLmlzKENvbW1vbkZsYWdzLkdFVCkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkV4cG9ydGVkIFNpbmdsZXRvbiBjbGFzcyBjYW5ub3QgaGF2ZSBwcm9wZXJ0aWVzLiBGb3VuZCBcIiArIG5vZGUubmFtZS50ZXh0KTtcbiAgICB9XG4gICAgbGV0IG5hbWUgPSB0b1N0cmluZyhub2RlLm5hbWUpO1xuICAgIGxldCBkZWNvcmF0b3JzID0gKG5vZGUuZGVjb3JhdG9ycyB8fCBbXSkubWFwKHRvU3RyaW5nKTtcbiAgICBsZXQgcmV0dXJuVHlwZSA9IHRvU3RyaW5nKG5vZGUuc2lnbmF0dXJlLnJldHVyblR5cGUpO1xuICAgIGxldCBvcmlnUGFyYW1zID0gbm9kZS5zaWduYXR1cmUucGFyYW1ldGVycy5tYXAodXRpbHMuY2xvbmVOb2RlKTtcbiAgICBsZXQgcGFyYW1ldGVycyA9IG9yaWdQYXJhbXMubWFwKHBhcmFtID0+IHtcbiAgICAgIGlmIChwYXJhbS5pbXBsaWNpdEZpZWxkRGVjbGFyYXRpb24pIHtcbiAgICAgICAgcGFyYW0ubmFtZS50ZXh0ID0gcGFyYW0ubmFtZS50ZXh0LnN1YnN0cmluZygyKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiB0b1N0cmluZyhwYXJhbSk7XG4gICAgfSk7XG4gICAgbGV0IHByYW1OYW1lcyA9IG9yaWdQYXJhbXMubWFwKChwYXJhbSkgPT4ge1xuICAgICAgcmV0dXJuIHRvU3RyaW5nKHBhcmFtLm5hbWUpXG4gICAgfVxuICAgICk7XG4gICAgbGV0IGlzSW5pdCA9IG5hbWUgPT09IFwiY29uc3RydWN0b3JcIjtcbiAgICBsZXQgYXNzZXJ0U3RyID0gaXNJbml0XG4gICAgICA/IGBhc3NlcnQoaXNOdWxsKF9fY29udHJhY3QpLCBcImNvbnRyYWN0IGlzIGFscmVhZHkgaW5pdGlhbGl6ZWRcIik7YFxuICAgICAgOiBgYXNzZXJ0KCFpc051bGwoX19jb250cmFjdCksIFwiY29udHJhY3QgaXMgbm90IGluaXRpYWxpemVkXCIpO2A7XG4gICAgbGV0IGlzVm9pZCA9IHJldHVyblR5cGUgPT09IFwidm9pZFwiO1xuICAgIGxldCBib2R5ID0gaXNJbml0XG4gICAgICA/IGBfX2NvbnRyYWN0ID0gbmV3ICR7dGhpcy5jbGFzc05hbWV9KCR7cHJhbU5hbWVzLmpvaW4oXCIsIFwiKX0pO2BcbiAgICAgIDogYCR7IWlzVm9pZCA/IFwibGV0IHJlcyA9ICBcIiA6IFwiXCJ9X19jb250cmFjdC4ke25hbWV9KCR7cHJhbU5hbWVzLmpvaW4oXCIsIFwiKX0pO2A7XG4gICAgaWYgKGlzSW5pdCkge1xuICAgICAgbmFtZSA9IFwiaW5pdFwiO1xuICAgICAgcGFyYW1ldGVycyA9IG9yaWdQYXJhbXMubWFwKFxuICAgICAgICAobm9kZSkgPT5cbiAgICAgICAgICBgJHt0b1N0cmluZyhub2RlLm5hbWUpfTogJHt0b1N0cmluZyhub2RlLnR5cGUpfSR7XG4gICAgICAgICAgICBub2RlLmluaXRpYWxpemVyID8gXCIgPSBcIiArIHRvU3RyaW5nKG5vZGUuaW5pdGlhbGl6ZXIpIDogXCJcIlxuICAgICAgICAgIH1gXG4gICAgICApO1xuICAgICAgcmV0dXJuVHlwZSA9IFwidm9pZFwiO1xuICAgIH1cbiAgICBpZiAoaXNJbml0KSB7XG4gICAgICBpZiAoIWRlY29yYXRvcnMuc29tZShkZWNvcmF0b3IgPT4gZGVjb3JhdG9yLmluY2x1ZGVzKFwiZXhwb3J0QXNcIikgKSl7XG4gICAgICAgIGRlY29yYXRvcnMucHVzaChgQGV4cG9ydEFzKFwibmV3XCIpYCk7XG4gICAgICB9XG4gICAgfVxuICAgIHRoaXMuc2IucHVzaChcbiAgICAgIGAke2RlY29yYXRvcnMuam9pbihcIlxcblwiKX1cbiAgICAgIGV4cG9ydCBmdW5jdGlvbiAke25hbWV9KCR7cGFyYW1ldGVycy5qb2luKFxuICAgICAgICBcIiwgXCJcbiAgICAgICl9KTogJHtyZXR1cm5UeXBlfSB7XG4gICR7YXNzZXJ0U3RyfVxuICAke2JvZHl9XG4gICR7aXNJbml0ID8gYF9fc2V0U3RhdGUoX19jb250cmFjdClgIDogXCJfX3VwZGF0ZVN0YXRlKF9fY29udHJhY3QpXCJ9O1xuICAke2lzVm9pZCB8fCBpc0luaXQgPyBcIlwiIDogXCJyZXR1cm4gcmVzXCJ9XG59YFxuICAgICk7XG4gIH1cblxuICB2aXNpdENsYXNzRGVjbGFyYXRpb24obm9kZTogQ2xhc3NEZWNsYXJhdGlvbik6IHZvaWQge1xuICAgIGlmIChpc0VudHJ5KG5vZGUpICYmIG5vZGUuaXMoQ29tbW9uRmxhZ3MuRVhQT1JUKSkge1xuICAgICAgbGV0IG5hbWUgPSB0b1N0cmluZyhub2RlLm5hbWUpO1xuICAgICAgaWYgKENsYXNzRXhwb3J0ZXIuY2xhc3NTZWVuKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgQ2Fubm90IGV4cG9ydCBjbGFzcyAke25hbWV9LiAke1xuICAgICAgICAgICAgQ2xhc3NFeHBvcnRlci5jbGFzc1NlZW5cbiAgICAgICAgICB9IGFscmVhZHkgZXhwb3J0ZWQuIGBcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIENsYXNzRXhwb3J0ZXIuY2xhc3NTZWVuID0gbm9kZTtcbiAgICAgIHRoaXMuc2IucHVzaChcbmBsZXQgX19jb250cmFjdDogJHtuYW1lfTtcbmlmIChfX2NoZWNrU3RhdGUoKSkge1xuICBfX2NvbnRyYWN0ID0gX19nZXRTdGF0ZTwke25hbWV9PigpO1xufWBcbiAgICAgICk7XG4gICAgICB0aGlzLnZpc2l0KG5vZGUubWVtYmVycyk7XG4gICAgICBub2RlLmZsYWdzID0gbm9kZS5mbGFncyBeIENvbW1vbkZsYWdzLkVYUE9SVDtcbiAgICAgIGxldCBuZXdTdGF0ZW1lbnRzID0gU2ltcGxlUGFyc2VyLnBhcnNlVG9wTGV2ZWwodGhpcy5zYi5qb2luKFwiXFxuXCIpKS5tYXAobiA9PiB7XG4gICAgICAgIGlmIChuIGluc3RhbmNlb2YgRnVuY3Rpb25EZWNsYXJhdGlvbikge1xuICAgICAgICAgIG4uZmxhZ3MgPSBuLmZsYWdzIHwgQ29tbW9uRmxhZ3MuRVhQT1JUXG4gICAgICAgICAgbi5mbGFncyA9IG4uZmxhZ3MgfCBDb21tb25GbGFncy5NT0RVTEVfRVhQT1JUXG4gICAgICAgIH1cbiAgICAgICAgbi5yYW5nZSA9IG5vZGUucmFuZ2U7XG4gICAgICAgIHJldHVybiBuO1xuICAgICAgfSk7XG4gICAgICBub2RlLnJhbmdlLnNvdXJjZS5zdGF0ZW1lbnRzLnB1c2goLi4ubmV3U3RhdGVtZW50cyk7XG4gICAgfVxuICB9XG5cbiAgZ2V0IG5hbWUoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gXCJuZWFyQmluZGdlblwiO1xuICB9XG5cbiAgc3RhdGljIHZpc2l0KHNvdXJjZTogU291cmNlKTogdm9pZCB7XG4gICAgaWYgKHNvdXJjZS5zb3VyY2VLaW5kICE9IFNvdXJjZUtpbmQuVVNFUl9FTlRSWSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBsZXQgdmlzaXRvciA9IG5ldyBDbGFzc0V4cG9ydGVyKCk7XG4gICAgdmlzaXRvci52aXNpdChzb3VyY2UpO1xuICB9XG59XG4iXX0=