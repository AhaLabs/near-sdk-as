"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.parseTopLevelStatements = exports.numOfParameters = exports.returnsVoid = exports.createEncodeStatements = exports.createDecodeStatement = exports.createDecodeStatements = exports.nearFiles = exports.isPayable = exports.isEncodable = exports.isStatic = exports.isField = exports.isClass = exports.isEntry = exports.hasNearDecorator = exports.WRAPPER_PREFIX = exports.PRIVATE_DECORATOR = exports.NEAR_DECORATOR = void 0;
const as_1 = require("visitor-as/as");
const visitor_as_1 = require("visitor-as");
exports.NEAR_DECORATOR = "nearBindgen";
exports.PRIVATE_DECORATOR = "contractPrivate";
exports.WRAPPER_PREFIX = "__wrapper_";
function hasNearDecorator(stmt) {
    return ((isEntry(stmt) ||
        stmt.text.includes("@nearfile") ||
        stmt.statements.some((s) => s instanceof as_1.DeclarationStatement &&
            visitor_as_1.utils.hasDecorator(s, exports.NEAR_DECORATOR))) &&
        !stmt.text.includes("@notNearfile"));
}
exports.hasNearDecorator = hasNearDecorator;
function isEntry(source) {
    return source.range.source.sourceKind == as_1.SourceKind.USER_ENTRY;
}
exports.isEntry = isEntry;
function isClass(type) {
    return type.kind == as_1.NodeKind.CLASSDECLARATION;
}
exports.isClass = isClass;
function isField(mem) {
    return mem.kind == as_1.NodeKind.FIELDDECLARATION;
}
exports.isField = isField;
function isStatic(mem) {
    return mem.is(as_1.CommonFlags.STATIC);
}
exports.isStatic = isStatic;
function isEncodable(mem) {
    return isField(mem) && !isStatic(mem);
}
exports.isEncodable = isEncodable;
function isPayable(func) {
    return (func.decorators != null &&
        func.decorators.some((s) => visitor_as_1.utils.toString(s.name) != "payable"));
}
exports.isPayable = isPayable;
function nearFiles(sources) {
    return sources.filter(hasNearDecorator);
}
exports.nearFiles = nearFiles;
function createDecodeStatements(_class) {
    return _class.members
        .filter(isEncodable)
        .map((field) => {
        const name = visitor_as_1.utils.toString(field.name);
        return (createDecodeStatement(field, `this.${name} = obj.has("${name}") ? `) +
            `: ${field.initializer != null
                ? visitor_as_1.utils.toString(field.initializer)
                : `this.${name}`};`);
    });
}
exports.createDecodeStatements = createDecodeStatements;
function createDecodeStatement(field, setterPrefix = "") {
    let T = visitor_as_1.utils.toString(field.type);
    let name = visitor_as_1.utils.toString(field.name);
    return `${setterPrefix}decode<${T}, JSON.Obj>(obj, "${name}")`;
}
exports.createDecodeStatement = createDecodeStatement;
function createEncodeStatements(_class) {
    return _class.members
        .filter(isEncodable)
        .map((field) => {
        let T = visitor_as_1.utils.toString(field.type);
        let name = visitor_as_1.utils.toString(field.name);
        return `encode<${T}, JSONEncoder>(this.${name}, "${name}", encoder);`;
    });
}
exports.createEncodeStatements = createEncodeStatements;
function returnsVoid(node) {
    return visitor_as_1.utils.toString(node.signature.returnType) === "void";
}
exports.returnsVoid = returnsVoid;
function numOfParameters(node) {
    return node.signature.parameters.length;
}
exports.numOfParameters = numOfParameters;
function parseTopLevelStatements(sourceCode) {
    const block = visitor_as_1.SimpleParser.parseTopLevelStatement(sourceCode);
    if (block instanceof as_1.BlockStatement) {
        return block.statements;
    }
    return [block];
}
exports.parseTopLevelStatements = parseTopLevelStatements;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tbW9uLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2NvbW1vbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxzQ0FhdUI7QUFFdkIsMkNBQWlEO0FBRXBDLFFBQUEsY0FBYyxHQUFHLGFBQWEsQ0FBQztBQUMvQixRQUFBLGlCQUFpQixHQUFHLGlCQUFpQixDQUFDO0FBQ3RDLFFBQUEsY0FBYyxHQUFHLFlBQVksQ0FBQztBQUUzQyxTQUFnQixnQkFBZ0IsQ0FBQyxJQUFZO0lBQzNDLE9BQU8sQ0FDTCxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUM7UUFDWixJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxXQUFXLENBQUM7UUFDL0IsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQ2xCLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FDSixDQUFDLFlBQVkseUJBQW9CO1lBQ2pDLGtCQUFLLENBQUMsWUFBWSxDQUFDLENBQUMsRUFBRSxzQkFBYyxDQUFDLENBQ3hDLENBQUM7UUFDSixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLGNBQWMsQ0FBQyxDQUNwQyxDQUFDO0FBQ0osQ0FBQztBQVhELDRDQVdDO0FBRUQsU0FBZ0IsT0FBTyxDQUFDLE1BQXFCO0lBQzNDLE9BQU8sTUFBTSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsVUFBVSxJQUFJLGVBQVUsQ0FBQyxVQUFVLENBQUM7QUFDakUsQ0FBQztBQUZELDBCQUVDO0FBRUQsU0FBZ0IsT0FBTyxDQUFDLElBQVU7SUFDaEMsT0FBTyxJQUFJLENBQUMsSUFBSSxJQUFJLGFBQVEsQ0FBQyxnQkFBZ0IsQ0FBQztBQUNoRCxDQUFDO0FBRkQsMEJBRUM7QUFFRCxTQUFnQixPQUFPLENBQUMsR0FBeUI7SUFDL0MsT0FBTyxHQUFHLENBQUMsSUFBSSxJQUFJLGFBQVEsQ0FBQyxnQkFBZ0IsQ0FBQztBQUMvQyxDQUFDO0FBRkQsMEJBRUM7QUFFRCxTQUFnQixRQUFR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dUJBQXVCLENBQUMsVUFBa0I7SUFDeEQsTUFBTSxLQUFLLEdBQUcseUJBQVksQ0FBQyxzQkFBc0IsQ0FBQyxVQUFVLENBQUMsQ0FBQztJQUM5RCxJQUFJLEtBQUssWUFBWSxtQkFBYyxFQUFFO1FBQ25DLE9BQU8sS0FBSyxDQUFDLFVBQVUsQ0FBQztLQUN6QjtJQUNELE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQztBQUNqQixDQUFDO0FBTkQsMERBTUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBDb21tb25GbGFncyxcbiAgRGVjbGFyYXRpb25TdGF0ZW1lbnQsXG4gIEZ1bmN0aW9uRGVjbGFyYXRpb24sXG4gIE5vZGVLaW5kLFxuICBTb3VyY2UsXG4gIFNvdXJjZUtpbmQsXG4gIE5vZGUsXG4gIENsYXNzRGVjbGFyYXRpb24sXG4gIEZpZWxkRGVjbGFyYXRpb24sXG4gIFBhcmFtZXRlck5vZGUsXG4gIFN0YXRlbWVudCxcbiAgQmxvY2tTdGF0ZW1lbnQsXG59IGZyb20gXCJ2aXNpdG9yLWFzL2FzXCI7XG5cbmltcG9ydCB7IFNpbXBsZVBhcnNlciwgdXRpbHMgfSBmcm9tIFwidmlzaXRvci1hc1wiO1xuXG5leHBvcnQgY29uc3QgTkVBUl9ERUNPUkFUT1IgPSBcIm5lYXJCaW5kZ2VuXCI7XG5leHBvcnQgY29uc3QgUFJJVkFURV9ERUNPUkFUT1IgPSBcImNvbnRyYWN0UHJpdmF0ZVwiO1xuZXhwb3J0IGNvbnN0IFdSQVBQRVJfUFJFRklYID0gXCJfX3dyYXBwZXJfXCI7XG5cbmV4cG9ydCBmdW5jdGlvbiBoYXNOZWFyRGVjb3JhdG9yKHN0bXQ6IFNvdXJjZSk6IGJvb2xlYW4ge1xuICByZXR1cm4gKFxuICAgIChpc0VudHJ5KHN0bXQpIHx8XG4gICAgICBzdG10LnRleHQuaW5jbHVkZXMoXCJAbmVhcmZpbGVcIikgfHxcbiAgICAgIHN0bXQuc3RhdGVtZW50cy5zb21lKFxuICAgICAgICAocykgPT5cbiAgICAgICAgICBzIGluc3RhbmNlb2YgRGVjbGFyYXRpb25TdGF0ZW1lbnQgJiZcbiAgICAgICAgICB1dGlscy5oYXNEZWNvcmF0b3IocywgTkVBUl9ERUNPUkFUT1IpXG4gICAgICApKSAmJlxuICAgICFzdG10LnRleHQuaW5jbHVkZXMoXCJAbm90TmVhcmZpbGVcIilcbiAgKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGlzRW50cnkoc291cmNlOiBTb3VyY2UgfCBOb2RlKTogYm9vbGVhbiB7XG4gIHJldHVybiBzb3VyY2UucmFuZ2Uuc291cmNlLnNvdXJjZUtpbmQgPT0gU291cmNlS2luZC5VU0VSX0VOVFJZO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gaXNDbGFzcyh0eXBlOiBOb2RlKTogYm9vbGVhbiB7XG4gIHJldHVybiB0eXBlLmtpbmQgPT0gTm9kZUtpbmQuQ0xBU1NERUNMQVJBVElPTjtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGlzRmllbGQobWVtOiBEZWNsYXJhdGlvblN0YXRlbWVudCkge1xuICByZXR1cm4gbWVtLmtpbmQgPT0gTm9kZUtpbmQuRklFTERERUNMQVJBVElPTjtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGlzU3RhdGljKG1lbTogRGVjbGFyYXRpb25TdGF0ZW1lbnQpIHtcbiAgcmV0dXJuIG1lbS5pcyhDb21tb25GbGFncy5TVEFUSUMpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gaXNFbmNvZGFibGUobWVtOiBEZWNsYXJhdGlvblN0YXRlbWVudCkge1xuICByZXR1cm4gaXNGaWVsZChtZW0pICYmICFpc1N0YXRpYyhtZW0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gaXNQYXlhYmxlKGZ1bmM6IEZ1bmN0aW9uRGVjbGFyYXRpb24pOiBib29sZWFuIHtcbiAgcmV0dXJuIChcbiAgICBmdW5jLmRlY29yYXRvcnMgIT0gbnVsbCAmJlxuICAgIGZ1bmMuZGVjb3JhdG9ycy5zb21lKChzKSA9PiB1dGlscy50b1N0cmluZyhzLm5hbWUpICE9IFwicGF5YWJsZVwiKVxuICApO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gbmVhckZpbGVzKHNvdXJjZXM6IFNvdXJjZVtdKTogU291cmNlW10ge1xuICByZXR1cm4gc291cmNlcy5maWx0ZXIoaGFzTmVhckRlY29yYXRvcik7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVEZWNvZGVTdGF0ZW1lbnRzKF9jbGFzczogQ2xhc3NEZWNsYXJhdGlvbik6IHN0cmluZ1tdIHtcbiAgcmV0dXJuIF9jbGFzcy5tZW1iZXJzXG4gICAgLmZpbHRlcihpc0VuY29kYWJsZSlcbiAgICAubWFwKChmaWVsZDogRmllbGREZWNsYXJhdGlvbik6IHN0cmluZyA9PiB7XG4gICAgICBjb25zdCBuYW1lID0gdXRpbHMudG9TdHJpbmcoZmllbGQubmFtZSk7XG4gICAgICByZXR1cm4gKFxuICAgICAgICBjcmVhdGVEZWNvZGVTdGF0ZW1lbnQoZmllbGQsIGB0aGlzLiR7bmFtZX0gPSBvYmouaGFzKFwiJHtuYW1lfVwiKSA/IGApICtcbiAgICAgICAgYDogJHtcbiAgICAgICAgICBmaWVsZC5pbml0aWFsaXplciAhPSBudWxsXG4gICAgICAgICAgICA/IHV0aWxzLnRvU3RyaW5nKGZpZWxkLmluaXRpYWxpemVyKVxuICAgICAgICAgICAgOiBgdGhpcy4ke25hbWV9YFxuICAgICAgICB9O2BcbiAgICAgICk7XG4gICAgfSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVEZWNvZGVTdGF0ZW1lbnQoXG4gIGZpZWxkOiBGaWVsZERlY2xhcmF0aW9uIHwgUGFyYW1ldGVyTm9kZSxcbiAgc2V0dGVyUHJlZml4ID0gXCJcIlxuKTogc3RyaW5nIHtcbiAgbGV0IFQgPSB1dGlscy50b1N0cmluZyhmaWVsZC50eXBlISk7XG4gIGxldCBuYW1lID0gdXRpbHMudG9TdHJpbmcoZmllbGQubmFtZSk7XG4gIHJldHVybiBgJHtzZXR0ZXJQcmVmaXh9ZGVjb2RlPCR7VH0sIEpTT04uT2JqPihvYmosIFwiJHtuYW1lfVwiKWA7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVFbmNvZGVTdGF0ZW1lbnRzKF9jbGFzczogQ2xhc3NEZWNsYXJhdGlvbik6IHN0cmluZ1tdIHtcbiAgcmV0dXJuIF9jbGFzcy5tZW1iZXJzXG4gICAgLmZpbHRlcihpc0VuY29kYWJsZSlcbiAgICAubWFwKChmaWVsZDogRmllbGREZWNsYXJhdGlvbik6IHN0cmluZyA9PiB7XG4gICAgICBsZXQgVCA9IHV0aWxzLnRvU3RyaW5nKGZpZWxkLnR5cGUhKTtcbiAgICAgIGxldCBuYW1lID0gdXRpbHMudG9TdHJpbmcoZmllbGQubmFtZSk7XG4gICAgICByZXR1cm4gYGVuY29kZTwke1R9LCBKU09ORW5jb2Rlcj4odGhpcy4ke25hbWV9LCBcIiR7bmFtZX1cIiwgZW5jb2Rlcik7YDtcbiAgICB9KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHJldHVybnNWb2lkKG5vZGU6IEZ1bmN0aW9uRGVjbGFyYXRpb24pOiBib29sZWFuIHtcbiAgcmV0dXJuIHV0aWxzLnRvU3RyaW5nKG5vZGUuc2lnbmF0dXJlLnJldHVyblR5cGUpID09PSBcInZvaWRcIjtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG51bU9mUGFyYW1ldGVycyhub2RlOiBGdW5jdGlvbkRlY2xhcmF0aW9uKTogbnVtYmVyIHtcbiAgcmV0dXJuIG5vZGUuc2lnbmF0dXJlLnBhcmFtZXRlcnMubGVuZ3RoO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcGFyc2VUb3BMZXZlbFN0YXRlbWVudHMoc291cmNlQ29kZTogc3RyaW5nKTogU3RhdGVtZW50W10ge1xuICBjb25zdCBibG9jayA9IFNpbXBsZVBhcnNlci5wYXJzZVRvcExldmVsU3RhdGVtZW50KHNvdXJjZUNvZGUpO1xuICBpZiAoYmxvY2sgaW5zdGFuY2VvZiBCbG9ja1N0YXRlbWVudCkge1xuICAgIHJldHVybiBibG9jay5zdGF0ZW1lbnRzO1xuICB9XG4gIHJldHVybiBbYmxvY2tdO1xufVxuIl19