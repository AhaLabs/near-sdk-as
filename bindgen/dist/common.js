"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.parseTopLevelStatements = exports.numOfParameters = exports.returnsVoid = exports.createEncodeStatements = exports.createDecodeStatement = exports.createDecodeStatements = exports.nearFiles = exports.isPayable = exports.isEncodable = exports.isStatic = exports.isField = exports.isClass = exports.isEntry = exports.hasNearDecorator = exports.WRAPPER_PREFIX = exports.PRIVATE_DECORATOR = exports.NEAR_DECORATOR = void 0;
const as_1 = require("visitor-as/as");
const visitor_as_1 = require("visitor-as");
exports.NEAR_DECORATOR = "nearBindgen";
exports.PRIVATE_DECORATOR = "contractPrivate";
exports.WRAPPER_PREFIX = "__wrapper_";
function hasNearDecorator(stmt) {
    return ((isEntry(stmt) ||
        stmt.text.includes("@nearfile") ||
        stmt.statements.some((s) => s instanceof as_1.DeclarationStatement &&
            visitor_as_1.utils.hasDecorator(s, exports.NEAR_DECORATOR))) &&
        !stmt.text.includes("@notNearfile"));
}
exports.hasNearDecorator = hasNearDecorator;
function isEntry(source) {
    return source.range.source.sourceKind == as_1.SourceKind.USER_ENTRY;
}
exports.isEntry = isEntry;
function isClass(type) {
    return type.kind == as_1.NodeKind.CLASSDECLARATION;
}
exports.isClass = isClass;
function isField(mem) {
    return mem.kind == as_1.NodeKind.FIELDDECLARATION;
}
exports.isField = isField;
function isStatic(mem) {
    return mem.is(as_1.CommonFlags.STATIC);
}
exports.isStatic = isStatic;
function isEncodable(mem) {
    return isField(mem) && !isStatic(mem);
}
exports.isEncodable = isEncodable;
function isPayable(func) {
    return (func.decorators != null &&
        func.decorators.some((s) => visitor_as_1.utils.toString(s.name) != "payable"));
}
exports.isPayable = isPayable;
function nearFiles(sources) {
    return sources.filter(hasNearDecorator);
}
exports.nearFiles = nearFiles;
function createDecodeStatements(_class) {
    return _class.members
        .filter(isEncodable)
        .map((field) => {
        const name = visitor_as_1.utils.toString(field.name);
        return (createDecodeStatement(field, `this.${name} = obj.has("${name}") ? `) +
            `: ${field.initializer != null
                ? visitor_as_1.utils.toString(field.initializer)
                : `this.${name}`};`);
    });
}
exports.createDecodeStatements = createDecodeStatements;
function createDecodeStatement(field, setterPrefix = "") {
    let T = visitor_as_1.utils.toString(field.type);
    let name = visitor_as_1.utils.toString(field.name);
    return `${setterPrefix}decode<${T}, JSON.Obj>(obj, "${name}")`;
}
exports.createDecodeStatement = createDecodeStatement;
function createEncodeStatements(_class) {
    return _class.members
        .filter(isEncodable)
        .map((field) => {
        let T = visitor_as_1.utils.toString(field.type);
        let name = visitor_as_1.utils.toString(field.name);
        return `encode<${T}, JSONEncoder>(this.${name}, "${name}", encoder);`;
    });
}
exports.createEncodeStatements = createEncodeStatements;
function returnsVoid(node) {
    return visitor_as_1.utils.toString(node.signature.returnType) === "void";
}
exports.returnsVoid = returnsVoid;
function numOfParameters(node) {
    return node.signature.parameters.length;
}
exports.numOfParameters = numOfParameters;
function parseTopLevelStatements(sourceCode) {
    const block = visitor_as_1.SimpleParser.parseTopLevelStatement(sourceCode);
    console.log(`BLOCK: ${as_1.NodeKind[block.kind]}
    ${visitor_as_1.utils.toString(block)}`);
    if (block instanceof as_1.BlockStatement) {
        return block.statements;
    }
    return [block];
}
exports.parseTopLevelStatements = parseTopLevelStatements;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tbW9uLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2NvbW1vbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxzQ0FhdUI7QUFFdkIsMkNBQWlEO0FBRXBDLFFBQUEsY0FBYyxHQUFHLGFBQWEsQ0FBQztBQUMvQixRQUFBLGlCQUFpQixHQUFHLGlCQUFpQixDQUFDO0FBQ3RDLFFBQUEsY0FBYyxHQUFHLFlBQVksQ0FBQztBQUUzQyxTQUFnQixnQkFBZ0IsQ0FBQyxJQUFZO0lBQzNDLE9BQU8sQ0FDTCxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUM7UUFDWixJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxXQUFXLENBQUM7UUFDL0IsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQ2xCLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FDSixDQUFDLFlBQVkseUJBQW9CO1lBQ2pDLGtCQUFLLENBQUMsWUFBWSxDQUFDLENBQUMsRUFBRSxzQkFBYyxDQUFDLENBQ3hDLENBQUM7UUFDSixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLGNBQWMsQ0FBQyxDQUNwQyxDQUFDO0FBQ0osQ0FBQztBQVhELDRDQVdDO0FBRUQsU0FBZ0IsT0FBTyxDQUFDLE1BQXFCO0lBQzNDLE9BQU8sTUFBTSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsVUFBVSxJQUFJLGVBQVUsQ0FBQyxVQUFVLENBQUM7QUFDakUsQ0FBQztBQUZELDBCQUVDO0FBRUQsU0FBZ0IsT0FBTyxDQUFDLElBQVU7SUFDaEMsT0FBTyxJQUFJLENBQUMsSUFBSSxJQUFJLGFBQVEsQ0FBQyxnQkFBZ0IsQ0FBQztBQUNoRCxDQUFDO0FBRkQsMEJBRUM7QUFFRCxTQUFnQixPQUFPLENBQUMsR0FBeUI7SUFDL0MsT0FBTyxHQUFHLENBQUMsSUFBSSxJQUFJLGFBQVEsQ0FBQyxnQkFBZ0IsQ0FBQztBQUMvQyxDQUFDO0FBRkQsMEJBRUM7QUFFRCxTQUFnQixRQUFRLENBQUMsR0FBeUI7SUFDaEQsT0FBTyxHQUFHLENBQUMsRUFBRSxDQUFDLGdCQUFXLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDcEMsQ0FBQztBQUZELDRCQUVDO0FBRUQsU0FBZ0IsV0FBVyxDQUFDLEdBQXlCO0lBQ25ELE9BQU8sT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBQ3hDLENBQUM7QUFGRCxrQ0FFQztBQUVELFNBQWdCLFNBQVMsQ0FBQyxJQUF5QjtJQUNqRCxPQUFPLENBQ0wsSUFBSSxDQUFDLFVBQVUsSUFBSSxJQUFJO1FBQ3ZCLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxrQkFBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksU0FBUyxDQUFDLENBQ2pFLENBQUM7QUFDSixDQUFDO0FBTEQsOEJBS0M7QUFFRCxTQUFnQixTQUFTLENBQUMsT0FBaUI7SUFDekMsT0FBTyxPQUFPLENBQUMsTUFBTSxDQUFDLGdCQUFnQixDQUFDLENBQUM7QUFDMUMsQ0FBQztBQUZELDhCQUVDO0FBRUQsU0FBZ0Isc0JBQXNCLENBQUMsTUFBd0I7SUFDN0QsT0FBTyxNQUFNLENBQUMsT0FBTztTQUNsQixNQUFNLENBQUMsV0FBVyxDQUFDO1NBQ25CLEdBQUcsQ0FBQyxDQUFDLEtBQXVCLEVBQVUsRUFBRTtRQUN2QyxNQUFNLElBQUksR0FBRyxrQkFBSyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDeEMsT0FBTyxDQUNMLHFCQUFxQixDQUFDLEtBQUssRUFBRSxRQUFRLElBQUksZUFBZSxJQUFJLE9BQU8sQ0FBQztZQUNwRSxLQUNFLEtBQUssQ0FBQyxXQUFXLElBQUksSUFBSTtnQkFDdkIsQ0FBQyxDQUFDLGtCQUFLLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUM7Z0JBQ25DLENBQUMsQ0FBQyxRQUFRLElBQUksRUFDbEIsR0FBRyxDQUNKLENBQUM7SUFDSixDQUFDLENBQUMsQ0FBQztBQUNQLENBQUM7QUFkRCx3REFjQztBQUVELFNBQWdCLHFCQUFxQixDQUNuQyxLQUF1QyxFQUN2QyxZQUFZLEdBQUcsRUFBRTtJQUVqQixJQUFJLENBQUMsR0FBRyxrQkFBSyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsSUFBSyxDQUFDLENBQUM7SUFDcEMsSUFBSSxJQUFJLEdBQUcsa0JBQUssQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3RDLE9BQU8sR0FBRyxZQUFZLFVBQVUsQ0FBQyxxQkFBcUIsSUFBSSxJQUFJLENBQUM7QUFDakUsQ0FBQztBQVBELHNEQU9DO0FBRUQsU0FBZ0Isc0JBQXNCLENBQUMsTUFBd0I7SUFDN0QsT0FBTyxNQUFNLENBQUMsT0FBTztTQUNsQixNQUFNLENBQUMsV0FBVyxDQUFDO1NBQ25CLEdBQUcsQ0FBQyxDQUFDLEtBQXVCLEVBQVUsRUFBRTtRQUN2QyxJQUFJLENBQUMsR0FBRyxrQkFBSyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsSUFBSyxDQUFDLENBQUM7UUFDcEMsSUFBSSxJQUFJLEdBQUcsa0JBQUssQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3RDLE9BQU8sVUFBVSxDQUFDLHVCQUF1QixJQUFJLE1BQU0sSUFBSSxjQUFjLENBQUM7SUFDeEUsQ0FBQyxDQUFDLENBQUM7QUFDUCxDQUFDO0FBUkQsd0RBUUM7QUFFRCxTQUFnQixXQUFXLENBQUMsSUFBeUI7SUFDbkQsT0FBTyxrQkFBSyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLFVBQVUsQ0FBQyxLQUFLLE1BQU0sQ0FBQztBQUM5RCxDQUFDO0FBRkQsa0NBRUM7QUFFRCxTQUFnQixlQUFlLENBQUMsSUFBeUI7SUFDdkQsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUM7QUFDMUMsQ0FBQztBQUZELDBDQUVDO0FBRUQsU0FBZ0IsdUJBQXVCLENBQUMsVUFBa0I7SUFDeEQsTUFBTSxLQUFLLEdBQUcseUJBQVksQ0FBQyxzQkFBc0IsQ0FBQyxVQUFVLENBQUMsQ0FBQztJQUM5RCxPQUFPLENBQUMsR0FBRyxDQUFDLFVBQVUsYUFBUSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUM7TUFDdEMsa0JBQUssQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBQzdCLElBQUksS0FBSyxZQUFZLG1CQUFjLEVBQUU7UUFDbkMsT0FBTyxLQUFLLENBQUMsVUFBVSxDQUFDO0tBQ3pCO0lBQ0QsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO0FBQ2pCLENBQUM7QUFSRCwwREFRQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIENvbW1vbkZsYWdzLFxuICBEZWNsYXJhdGlvblN0YXRlbWVudCxcbiAgRnVuY3Rpb25EZWNsYXJhdGlvbixcbiAgTm9kZUtpbmQsXG4gIFNvdXJjZSxcbiAgU291cmNlS2luZCxcbiAgTm9kZSxcbiAgQ2xhc3NEZWNsYXJhdGlvbixcbiAgRmllbGREZWNsYXJhdGlvbixcbiAgUGFyYW1ldGVyTm9kZSxcbiAgU3RhdGVtZW50LFxuICBCbG9ja1N0YXRlbWVudCxcbn0gZnJvbSBcInZpc2l0b3ItYXMvYXNcIjtcblxuaW1wb3J0IHsgU2ltcGxlUGFyc2VyLCB1dGlscyB9IGZyb20gXCJ2aXNpdG9yLWFzXCI7XG5cbmV4cG9ydCBjb25zdCBORUFSX0RFQ09SQVRPUiA9IFwibmVhckJpbmRnZW5cIjtcbmV4cG9ydCBjb25zdCBQUklWQVRFX0RFQ09SQVRPUiA9IFwiY29udHJhY3RQcml2YXRlXCI7XG5leHBvcnQgY29uc3QgV1JBUFBFUl9QUkVGSVggPSBcIl9fd3JhcHBlcl9cIjtcblxuZXhwb3J0IGZ1bmN0aW9uIGhhc05lYXJEZWNvcmF0b3Ioc3RtdDogU291cmNlKTogYm9vbGVhbiB7XG4gIHJldHVybiAoXG4gICAgKGlzRW50cnkoc3RtdCkgfHxcbiAgICAgIHN0bXQudGV4dC5pbmNsdWRlcyhcIkBuZWFyZmlsZVwiKSB8fFxuICAgICAgc3RtdC5zdGF0ZW1lbnRzLnNvbWUoXG4gICAgICAgIChzKSA9PlxuICAgICAgICAgIHMgaW5zdGFuY2VvZiBEZWNsYXJhdGlvblN0YXRlbWVudCAmJlxuICAgICAgICAgIHV0aWxzLmhhc0RlY29yYXRvcihzLCBORUFSX0RFQ09SQVRPUilcbiAgICAgICkpICYmXG4gICAgIXN0bXQudGV4dC5pbmNsdWRlcyhcIkBub3ROZWFyZmlsZVwiKVxuICApO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gaXNFbnRyeShzb3VyY2U6IFNvdXJjZSB8IE5vZGUpOiBib29sZWFuIHtcbiAgcmV0dXJuIHNvdXJjZS5yYW5nZS5zb3VyY2Uuc291cmNlS2luZCA9PSBTb3VyY2VLaW5kLlVTRVJfRU5UUlk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpc0NsYXNzKHR5cGU6IE5vZGUpOiBib29sZWFuIHtcbiAgcmV0dXJuIHR5cGUua2luZCA9PSBOb2RlS2luZC5DTEFTU0RFQ0xBUkFUSU9OO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gaXNGaWVsZChtZW06IERlY2xhcmF0aW9uU3RhdGVtZW50KSB7XG4gIHJldHVybiBtZW0ua2luZCA9PSBOb2RlS2luZC5GSUVMRERFQ0xBUkFUSU9OO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gaXNTdGF0aWMobWVtOiBEZWNsYXJhdGlvblN0YXRlbWVudCkge1xuICByZXR1cm4gbWVtLmlzKENvbW1vbkZsYWdzLlNUQVRJQyk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpc0VuY29kYWJsZShtZW06IERlY2xhcmF0aW9uU3RhdGVtZW50KSB7XG4gIHJldHVybiBpc0ZpZWxkKG1lbSkgJiYgIWlzU3RhdGljKG1lbSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpc1BheWFibGUoZnVuYzogRnVuY3Rpb25EZWNsYXJhdGlvbik6IGJvb2xlYW4ge1xuICByZXR1cm4gKFxuICAgIGZ1bmMuZGVjb3JhdG9ycyAhPSBudWxsICYmXG4gICAgZnVuYy5kZWNvcmF0b3JzLnNvbWUoKHMpID0+IHV0aWxzLnRvU3RyaW5nKHMubmFtZSkgIT0gXCJwYXlhYmxlXCIpXG4gICk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBuZWFyRmlsZXMoc291cmNlczogU291cmNlW10pOiBTb3VyY2VbXSB7XG4gIHJldHVybiBzb3VyY2VzLmZpbHRlcihoYXNOZWFyRGVjb3JhdG9yKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZURlY29kZVN0YXRlbWVudHMoX2NsYXNzOiBDbGFzc0RlY2xhcmF0aW9uKTogc3RyaW5nW10ge1xuICByZXR1cm4gX2NsYXNzLm1lbWJlcnNcbiAgICAuZmlsdGVyKGlzRW5jb2RhYmxlKVxuICAgIC5tYXAoKGZpZWxkOiBGaWVsZERlY2xhcmF0aW9uKTogc3RyaW5nID0+IHtcbiAgICAgIGNvbnN0IG5hbWUgPSB1dGlscy50b1N0cmluZyhmaWVsZC5uYW1lKTtcbiAgICAgIHJldHVybiAoXG4gICAgICAgIGNyZWF0ZURlY29kZVN0YXRlbWVudChmaWVsZCwgYHRoaXMuJHtuYW1lfSA9IG9iai5oYXMoXCIke25hbWV9XCIpID8gYCkgK1xuICAgICAgICBgOiAke1xuICAgICAgICAgIGZpZWxkLmluaXRpYWxpemVyICE9IG51bGxcbiAgICAgICAgICAgID8gdXRpbHMudG9TdHJpbmcoZmllbGQuaW5pdGlhbGl6ZXIpXG4gICAgICAgICAgICA6IGB0aGlzLiR7bmFtZX1gXG4gICAgICAgIH07YFxuICAgICAgKTtcbiAgICB9KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZURlY29kZVN0YXRlbWVudChcbiAgZmllbGQ6IEZpZWxkRGVjbGFyYXRpb24gfCBQYXJhbWV0ZXJOb2RlLFxuICBzZXR0ZXJQcmVmaXggPSBcIlwiXG4pOiBzdHJpbmcge1xuICBsZXQgVCA9IHV0aWxzLnRvU3RyaW5nKGZpZWxkLnR5cGUhKTtcbiAgbGV0IG5hbWUgPSB1dGlscy50b1N0cmluZyhmaWVsZC5uYW1lKTtcbiAgcmV0dXJuIGAke3NldHRlclByZWZpeH1kZWNvZGU8JHtUfSwgSlNPTi5PYmo+KG9iaiwgXCIke25hbWV9XCIpYDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZUVuY29kZVN0YXRlbWVudHMoX2NsYXNzOiBDbGFzc0RlY2xhcmF0aW9uKTogc3RyaW5nW10ge1xuICByZXR1cm4gX2NsYXNzLm1lbWJlcnNcbiAgICAuZmlsdGVyKGlzRW5jb2RhYmxlKVxuICAgIC5tYXAoKGZpZWxkOiBGaWVsZERlY2xhcmF0aW9uKTogc3RyaW5nID0+IHtcbiAgICAgIGxldCBUID0gdXRpbHMudG9TdHJpbmcoZmllbGQudHlwZSEpO1xuICAgICAgbGV0IG5hbWUgPSB1dGlscy50b1N0cmluZyhmaWVsZC5uYW1lKTtcbiAgICAgIHJldHVybiBgZW5jb2RlPCR7VH0sIEpTT05FbmNvZGVyPih0aGlzLiR7bmFtZX0sIFwiJHtuYW1lfVwiLCBlbmNvZGVyKTtgO1xuICAgIH0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcmV0dXJuc1ZvaWQobm9kZTogRnVuY3Rpb25EZWNsYXJhdGlvbik6IGJvb2xlYW4ge1xuICByZXR1cm4gdXRpbHMudG9TdHJpbmcobm9kZS5zaWduYXR1cmUucmV0dXJuVHlwZSkgPT09IFwidm9pZFwiO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gbnVtT2ZQYXJhbWV0ZXJzKG5vZGU6IEZ1bmN0aW9uRGVjbGFyYXRpb24pOiBudW1iZXIge1xuICByZXR1cm4gbm9kZS5zaWduYXR1cmUucGFyYW1ldGVycy5sZW5ndGg7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBwYXJzZVRvcExldmVsU3RhdGVtZW50cyhzb3VyY2VDb2RlOiBzdHJpbmcpOiBTdGF0ZW1lbnRbXSB7XG4gIGNvbnN0IGJsb2NrID0gU2ltcGxlUGFyc2VyLnBhcnNlVG9wTGV2ZWxTdGF0ZW1lbnQoc291cmNlQ29kZSk7XG4gIGNvbnNvbGUubG9nKGBCTE9DSzogJHtOb2RlS2luZFtibG9jay5raW5kXX1cbiAgICAke3V0aWxzLnRvU3RyaW5nKGJsb2NrKX1gKTtcbiAgaWYgKGJsb2NrIGluc3RhbmNlb2YgQmxvY2tTdGF0ZW1lbnQpIHtcbiAgICByZXR1cm4gYmxvY2suc3RhdGVtZW50cztcbiAgfVxuICByZXR1cm4gW2Jsb2NrXTtcbn1cbiJdfQ==