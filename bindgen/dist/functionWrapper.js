"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.FunctionExportWrapper = exports.FunctionClass = void 0;
const as_1 = require("visitor-as/as");
const visitor_as_1 = require("visitor-as");
const common_1 = require("./common");
const utils_1 = require("./utils");
const transformRange_1 = require("visitor-as/dist/transformRange");
class FunctionClass extends visitor_as_1.BaseVisitor {
    _class;
    visitFunctionDeclaration(node) {
        let name = utils_1.getName(node);
        let fields = node.signature.parameters.map((p) => `${utils_1.toString(p.name)}: ${utils_1.getName(p.type)}${p.initializer ? " = " + utils_1.toString(p.initializer) : ""}`);
        let params = node.signature.parameters.map((p) => `this.${utils_1.getName(p)}`);
        if (fields.length > 0) {
            // add blank to make join add ;
            fields.push("");
        }
        const fieldStrs = fields.join(";\n");
        let _classStr = `class ${name}__class {
  ${fieldStrs}
  call(): ${utils_1.getName(node.signature.returnType)} {
    ${common_1.returnsVoid(node) ? "" : "return "}${name}(${params.join(",")});
  }
}`;
        let _class = (visitor_as_1.SimpleParser.parseTopLevelStatement(_classStr));
        // MethodInjector.visit(_class);
        this._class = _class;
    }
    static visit(node) {
        const funcClass = new FunctionClass();
        funcClass.visit(node);
        return funcClass._class;
    }
}
exports.FunctionClass = FunctionClass;
function emptySignature(node) {
    return common_1.numOfParameters(node) == 0 && common_1.returnsVoid(node);
}
class FunctionExportWrapper extends visitor_as_1.BaseVisitor {
    static isTest = false;
    functions = [];
    exports = [];
    wrappedFuncs = new Set();
    classWrappers = [];
    static checkTestBuild(sources) {
        this.isTest = sources.some((s) => s.normalizedPath.includes(".spec."));
    }
    needsWrapper(node) {
        let isExport = node.is(as_1.CommonFlags.EXPORT);
        let alreadyWrapped = this.wrappedFuncs.has(utils_1.toString(node.name));
        let noInputOrOutput = emptySignature(node);
        if (!isExport ||
            alreadyWrapped ||
            noInputOrOutput ||
            FunctionExportWrapper.isTest)
            return false;
        return common_1.isEntry(node) || visitor_as_1.utils.hasDecorator(node, common_1.NEAR_DECORATOR);
    }
    visitFunctionDeclaration(node) {
        const name = utils_1.toString(node.name);
        if (!this.needsWrapper(node)) {
            if ((common_1.isEntry(node) || visitor_as_1.utils.hasDecorator(node, common_1.NEAR_DECORATOR)) &&
                !this.wrappedFuncs.has(name) &&
                node.is(as_1.CommonFlags.EXPORT)) {
                const snakeCase = this.camelCaseToSnakeCaseExport(name, "");
                this.wrappedFuncs.add(name);
                if (snakeCase) {
                    this.exports.push(snakeCase);
                }
            }
            super.visitFunctionDeclaration(node);
            return;
        }
        if (common_1.numOfParameters(node) > 0) {
            const _class = FunctionClass.visit(node);
            transformRange_1.RangeTransform.visit(_class, node);
            this.classWrappers.push(_class);
        }
        this.functions.push(common_1.parseTopLevelStatements(this.generateWrapperFunction(node))[0]);
        // Change function to not be an export
        node.flags = node.flags ^ as_1.CommonFlags.EXPORT;
        this.wrappedFuncs.add(name);
    }
    camelCaseToSnakeCaseExport(name, prefix = common_1.WRAPPER_PREFIX) {
        let s = utils_1.makeSnakeCase(name);
        if (s.normalize() === name.normalize()) {
            return "";
        }
        return `export { ${prefix + name} as ${s} }`;
    }
    /*
    Create a wrapper function that will be export in the function's place.
    */
    generateWrapperFunction(func) {
        let funcSource = [];
        let signature = func.signature;
        let params = signature.parameters;
        let returnType = signature.returnType;
        let returnTypeName = utils_1.toString(returnType);
        let name = utils_1.getName(func);
        if (func.decorators && func.decorators.length > 0) {
            funcSource.push(func.decorators.map((decorator) => utils_1.toString(decorator)).join("\n"));
        }
        const className = name + "__class";
        funcSource.push(`
    function __wrapper_${name}(): void {`);
        if (params.length > 0) {
            funcSource.push(`  const _class = JSON.parse<${className}>(getInputString())`);
        }
        if (returnTypeName !== "void") {
            if (params.length > 0) {
                funcSource.push(`let result: ${returnTypeName} = _class.call();`);
            }
            else {
                funcSource.push(`let result: ${returnTypeName} = ${name}();`);
            }
            funcSource.push(`
      const val = String.UTF8.encode(JSON.stringify(result));
      value_return(val.byteLength, changetype<usize>(val));
  `);
        }
        else {
            if (params.length > 0) {
                funcSource.push(`_class.call()`);
            }
            else {
                funcSource.push(`${name}();`);
            }
        }
        funcSource.push(`}`);
        this.addExport(name);
        return funcSource.join("\n");
    }
    addExport(name) {
        this.exports.push(`export {${common_1.WRAPPER_PREFIX + name} as ${name}}`);
        let res = this.camelCaseToSnakeCaseExport(name, common_1.WRAPPER_PREFIX);
        if (res) {
            this.exports.push(res);
        }
    }
    visitSource(node) {
        super.visitSource(node);
        const newParser = new as_1.Parser();
        const lastStatement = (node.statements.length && node.statements[node.statements.length - 1]) ||
            node;
        if (this.functions.length > 0) {
            node.statements.push(...this.functions.map((n) => transformRange_1.RangeTransform.visit(n, lastStatement)));
            const str = this.exports.join("\n");
            newParser.parseFile(str, node.normalizedPath, common_1.isEntry(node));
            const exportsSource = newParser.sources[0];
            node.statements = node.statements.concat(exportsSource.statements);
            node.statements.push(...this.classWrappers);
        }
    }
    static visit(sources) {
        FunctionExportWrapper.checkTestBuild(sources);
        sources.forEach((s) => {
            new FunctionExportWrapper().visit(s);
        });
    }
}
exports.FunctionExportWrapper = FunctionExportWrapper;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZnVuY3Rpb25XcmFwcGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2Z1bmN0aW9uV3JhcHBlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxzQ0FTdUI7QUFDdkIsMkNBQThEO0FBQzlELHFDQVFrQjtBQUNsQixtQ0FBMkQ7QUFDM0QsbUVBQWdFO0FBRWhFLE1BQWEsYUFBYyxTQUFRLHdCQUFXO0lBQzVDLE1BQU0sQ0FBb0I7SUFFMUIsd0JBQXdCLENBQUMsSUFBeUI7UUFDaEQsSUFBSSxJQUFJLEdBQUcsZUFBTyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3pCLElBQUksTUFBTSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FDeEMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLEdBQUcsZ0JBQVEsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssZUFBTyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxLQUFLLEdBQUMsZ0JBQVEsQ0FBQyxDQUFDLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUN0RyxDQUFDO1FBQ0YsSUFBSSxNQUFNLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxRQUFRLGVBQU8sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDeEUsSUFBSSxNQUFNLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtZQUNyQiwrQkFBK0I7WUFDL0IsTUFBTSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztTQUNqQjtRQUVELE1BQU0sU0FBUyxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDckMsSUFBSSxTQUFTLEdBQUcsU0FBUyxJQUFJO0lBQzdCLFNBQVM7WUFDRCxl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QywrQkFBYyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsYUFBYSxDQUFDLENBQUMsQ0FDckUsQ0FBQztZQUVGLE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ3BDLFNBQVMsQ0FBQyxTQUFTLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxjQUFjLEVBQUUsZ0JBQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQzdELE1BQU0sYUFBYSxHQUFHLFNBQVMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDM0MsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxhQUFhLENBQUMsVUFBVSxDQUFDLENBQUM7WUFDbkUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUM7U0FDN0M7SUFDSCxDQUFDO0lBRUQsTUFBTSxDQUFDLEtBQUssQ0FBQyxPQUFpQjtRQUM1QixxQkFBcUIsQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDOUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFO1lBQ3BCLElBQUkscUJBQXFCLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDdkMsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDOztBQS9JSCxzREFnSkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBDbGFzc0RlY2xhcmF0aW9uLFxuICBTb3VyY2UsXG4gIENvbW1vbkZsYWdzLFxuICBGdW5jdGlvbkRlY2xhcmF0aW9uLFxuICBTdGF0ZW1lbnQsXG4gIFByb2dyYW0sXG4gIE5vZGVLaW5kLFxuICBQYXJzZXIsXG59IGZyb20gXCJ2aXNpdG9yLWFzL2FzXCI7XG5pbXBvcnQgeyB1dGlscywgQmFzZVZpc2l0b3IsIFNpbXBsZVBhcnNlciB9IGZyb20gXCJ2aXNpdG9yLWFzXCI7XG5pbXBvcnQge1xuICBjcmVhdGVEZWNvZGVTdGF0ZW1lbnQsXG4gIGlzRW50cnksXG4gIE5FQVJfREVDT1JBVE9SLFxuICBudW1PZlBhcmFtZXRlcnMsXG4gIHBhcnNlVG9wTGV2ZWxTdGF0ZW1lbnRzLFxuICByZXR1cm5zVm9pZCxcbiAgV1JBUFBFUl9QUkVGSVgsXG59IGZyb20gXCIuL2NvbW1vblwiO1xuaW1wb3J0IHsgZ2V0TmFtZSwgbWFrZVNuYWtlQ2FzZSwgdG9TdHJpbmcgfSBmcm9tIFwiLi91dGlsc1wiO1xuaW1wb3J0IHsgUmFuZ2VUcmFuc2Zvcm0gfSBmcm9tIFwidmlzaXRvci1hcy9kaXN0L3RyYW5zZm9ybVJhbmdlXCI7XG5cbmV4cG9ydCBjbGFzcyBGdW5jdGlvbkNsYXNzIGV4dGVuZHMgQmFzZVZpc2l0b3Ige1xuICBfY2xhc3MhOiBDbGFzc0RlY2xhcmF0aW9uO1xuXG4gIHZpc2l0RnVuY3Rpb25EZWNsYXJhdGlvbihub2RlOiBGdW5jdGlvbkRlY2xhcmF0aW9uKTogdm9pZCB7XG4gICAgbGV0IG5hbWUgPSBnZXROYW1lKG5vZGUpO1xuICAgIGxldCBmaWVsZHMgPSBub2RlLnNpZ25hdHVyZS5wYXJhbWV0ZXJzLm1hcChcbiAgICAgIChwKSA9PiBgJHt0b1N0cmluZyhwLm5hbWUpfTogJHtnZXROYW1lKHAudHlwZSl9JHtwLmluaXRpYWxpemVyID8gXCIgPSBcIit0b1N0cmluZyhwLmluaXRpYWxpemVyKSA6IFwiXCJ9YFxuICAgICk7XG4gICAgbGV0IHBhcmFtcyA9IG5vZGUuc2lnbmF0dXJlLnBhcmFtZXRlcnMubWFwKChwKSA9PiBgdGhpcy4ke2dldE5hbWUocCl9YCk7XG4gICAgaWYgKGZpZWxkcy5sZW5ndGggPiAwKSB7XG4gICAgICAvLyBhZGQgYmxhbmsgdG8gbWFrZSBqb2luIGFkZCA7XG4gICAgICBmaWVsZHMucHVzaChcIlwiKTtcbiAgICB9XG5cbiAgICBjb25zdCBmaWVsZFN0cnMgPSBmaWVsZHMuam9pbihcIjtcXG5cIik7XG4gICAgbGV0IF9jbGFzc1N0ciA9IGBjbGFzcyAke25hbWV9X19jbGFzcyB7XG4gICR7ZmllbGRTdHJzfVxuICBjYWxsKCk6ICR7Z2V0TmFtZShub2RlLnNpZ25hdHVyZS5yZXR1cm5UeXBlKX0ge1xuICAgICR7cmV0dXJuc1ZvaWQobm9kZSkgPyBcIlwiIDogXCJyZXR1cm4gXCJ9JHtuYW1lfSgke3BhcmFtcy5qb2luKFwiLFwiKX0pO1xuICB9XG59YDtcbiAgICBsZXQgX2NsYXNzID0gPENsYXNzRGVjbGFyYXRpb24+KFxuICAgICAgU2ltcGxlUGFyc2VyLnBhcnNlVG9wTGV2ZWxTdGF0ZW1lbnQoX2NsYXNzU3RyKVxuICAgICk7XG4gICAgLy8gTWV0aG9kSW5qZWN0b3IudmlzaXQoX2NsYXNzKTtcbiAgICB0aGlzLl9jbGFzcyA9IF9jbGFzcztcbiAgfVxuXG4gIHN0YXRpYyB2aXNpdChub2RlOiBGdW5jdGlvbkRlY2xhcmF0aW9uKTogQ2xhc3NEZWNsYXJhdGlvbiB7XG4gICAgY29uc3QgZnVuY0NsYXNzID0gbmV3IEZ1bmN0aW9uQ2xhc3MoKTtcbiAgICBmdW5jQ2xhc3MudmlzaXQobm9kZSk7XG4gICAgcmV0dXJuIGZ1bmNDbGFzcy5fY2xhc3M7XG4gIH1cbn1cblxuZnVuY3Rpb24gZW1wdHlTaWduYXR1cmUobm9kZTogRnVuY3Rpb25EZWNsYXJhdGlvbik6IGJvb2xlYW4ge1xuICByZXR1cm4gbnVtT2ZQYXJhbWV0ZXJzKG5vZGUpID09IDAgJiYgcmV0dXJuc1ZvaWQobm9kZSk7XG59XG5leHBvcnQgY2xhc3MgRnVuY3Rpb25FeHBvcnRXcmFwcGVyIGV4dGVuZHMgQmFzZVZpc2l0b3Ige1xuICBzdGF0aWMgaXNUZXN0OiBib29sZWFuID0gZmFsc2U7XG4gIGZ1bmN0aW9uczogU3RhdGVtZW50W10gPSBbXTtcbiAgZXhwb3J0czogc3RyaW5nW10gPSBbXTtcbiAgd3JhcHBlZEZ1bmNzOiBTZXQ8c3RyaW5nPiA9IG5ldyBTZXQoKTtcbiAgY2xhc3NXcmFwcGVyczogQ2xhc3NEZWNsYXJhdGlvbltdID0gW107XG5cbiAgc3RhdGljIGNoZWNrVGVzdEJ1aWxkKHNvdXJjZXM6IFNvdXJjZVtdKSB7XG4gICAgdGhpcy5pc1Rlc3QgPSBzb3VyY2VzLnNvbWUoKHMpID0+IHMubm9ybWFsaXplZFBhdGguaW5jbHVkZXMoXCIuc3BlYy5cIikpO1xuICB9XG5cbiAgbmVlZHNXcmFwcGVyKG5vZGU6IEZ1bmN0aW9uRGVjbGFyYXRpb24pOiBib29sZWFuIHtcbiAgICBsZXQgaXNFeHBvcnQgPSBub2RlLmlzKENvbW1vbkZsYWdzLkVYUE9SVCk7XG4gICAgbGV0IGFscmVhZHlXcmFwcGVkID0gdGhpcy53cmFwcGVkRnVuY3MuaGFzKHRvU3RyaW5nKG5vZGUubmFtZSkpO1xuICAgIGxldCBub0lucHV0T3JPdXRwdXQgPSBlbXB0eVNpZ25hdHVyZShub2RlKTtcbiAgICBpZiAoXG4gICAgICAhaXNFeHBvcnQgfHxcbiAgICAgIGFscmVhZHlXcmFwcGVkIHx8XG4gICAgICBub0lucHV0T3JPdXRwdXQgfHxcbiAgICAgIEZ1bmN0aW9uRXhwb3J0V3JhcHBlci5pc1Rlc3RcbiAgICApXG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgcmV0dXJuIGlzRW50cnkobm9kZSkgfHwgdXRpbHMuaGFzRGVjb3JhdG9yKG5vZGUsIE5FQVJfREVDT1JBVE9SKTtcbiAgfVxuXG4gIHZpc2l0RnVuY3Rpb25EZWNsYXJhdGlvbihub2RlOiBGdW5jdGlvbkRlY2xhcmF0aW9uKTogdm9pZCB7XG4gICAgY29uc3QgbmFtZSA9IHRvU3RyaW5nKG5vZGUubmFtZSk7XG4gICAgaWYgKCF0aGlzLm5lZWRzV3JhcHBlcihub2RlKSkge1xuICAgICAgaWYgKFxuICAgICAgICAoaXNFbnRyeShub2RlKSB8fCB1dGlscy5oYXNEZWNvcmF0b3Iobm9kZSwgTkVBUl9ERUNPUkFUT1IpKSAmJlxuICAgICAgICAhdGhpcy53cmFwcGVkRnVuY3MuaGFzKG5hbWUpICYmXG4gICAgICAgIG5vZGUuaXMoQ29tbW9uRmxhZ3MuRVhQT1JUKVxuICAgICAgKSB7XG4gICAgICAgIGNvbnN0IHNuYWtlQ2FzZSA9IHRoaXMuY2FtZWxDYXNlVG9TbmFrZUNhc2VFeHBvcnQobmFtZSwgXCJcIik7XG4gICAgICAgIHRoaXMud3JhcHBlZEZ1bmNzLmFkZChuYW1lKTtcbiAgICAgICAgaWYgKHNuYWtlQ2FzZSkge1xuICAgICAgICAgIHRoaXMuZXhwb3J0cy5wdXNoKHNuYWtlQ2FzZSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHN1cGVyLnZpc2l0RnVuY3Rpb25EZWNsYXJhdGlvbihub2RlKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKG51bU9mUGFyYW1ldGVycyhub2RlKSA+IDApIHtcbiAgICAgIGNvbnN0IF9jbGFzcyA9IEZ1bmN0aW9uQ2xhc3MudmlzaXQobm9kZSk7XG4gICAgICBSYW5nZVRyYW5zZm9ybS52aXNpdChfY2xhc3MsIG5vZGUpO1xuICAgICAgdGhpcy5jbGFzc1dyYXBwZXJzLnB1c2goX2NsYXNzKTtcbiAgICB9XG4gICAgdGhpcy5mdW5jdGlvbnMucHVzaChcbiAgICAgIHBhcnNlVG9wTGV2ZWxTdGF0ZW1lbnRzKHRoaXMuZ2VuZXJhdGVXcmFwcGVyRnVuY3Rpb24obm9kZSkpWzBdXG4gICAgKTtcbiAgICAvLyBDaGFuZ2UgZnVuY3Rpb24gdG8gbm90IGJlIGFuIGV4cG9ydFxuICAgIG5vZGUuZmxhZ3MgPSBub2RlLmZsYWdzIF4gQ29tbW9uRmxhZ3MuRVhQT1JUO1xuICAgIHRoaXMud3JhcHBlZEZ1bmNzLmFkZChuYW1lKTtcbiAgfVxuXG4gIGNhbWVsQ2FzZVRvU25ha2VDYXNlRXhwb3J0KFxuICAgIG5hbWU6IHN0cmluZyxcbiAgICBwcmVmaXg6IHN0cmluZyA9IFdSQVBQRVJfUFJFRklYXG4gICk6IHN0cmluZyB7XG4gICAgbGV0IHMgPSBtYWtlU25ha2VDYXNlKG5hbWUpO1xuICAgIGlmIChzLm5vcm1hbGl6ZSgpID09PSBuYW1lLm5vcm1hbGl6ZSgpKSB7XG4gICAgICByZXR1cm4gXCJcIjtcbiAgICB9XG4gICAgcmV0dXJuIGBleHBvcnQgeyAke3ByZWZpeCArIG5hbWV9IGFzICR7c30gfWA7XG4gIH1cblxuICAvKlxuICBDcmVhdGUgYSB3cmFwcGVyIGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBleHBvcnQgaW4gdGhlIGZ1bmN0aW9uJ3MgcGxhY2UuXG4gICovXG4gIHByaXZhdGUgZ2VuZXJhdGVXcmFwcGVyRnVuY3Rpb24oZnVuYzogRnVuY3Rpb25EZWNsYXJhdGlvbik6IHN0cmluZyB7XG4gICAgbGV0IGZ1bmNTb3VyY2U6IHN0cmluZ1tdID0gW107XG4gICAgbGV0IHNpZ25hdHVyZSA9IGZ1bmMuc2lnbmF0dXJlO1xuICAgIGxldCBwYXJhbXMgPSBzaWduYXR1cmUucGFyYW1ldGVycztcbiAgICBsZXQgcmV0dXJuVHlwZSA9IHNpZ25hdHVyZS5yZXR1cm5UeXBlO1xuICAgIGxldCByZXR1cm5UeXBlTmFtZSA9IHRvU3RyaW5nKHJldHVyblR5cGUpO1xuICAgIGxldCBuYW1lID0gZ2V0TmFtZShmdW5jKTtcbiAgICBpZiAoZnVuYy5kZWNvcmF0b3JzICYmIGZ1bmMuZGVjb3JhdG9ycy5sZW5ndGggPiAwKSB7XG4gICAgICBmdW5jU291cmNlLnB1c2goXG4gICAgICAgIGZ1bmMuZGVjb3JhdG9ycy5tYXAoKGRlY29yYXRvcikgPT4gdG9TdHJpbmcoZGVjb3JhdG9yKSkuam9pbihcIlxcblwiKVxuICAgICAgKTtcbiAgICB9XG4gICAgY29uc3QgY2xhc3NOYW1lID0gbmFtZSArIFwiX19jbGFzc1wiO1xuICAgIGZ1bmNTb3VyY2UucHVzaChgXG4gICAgZnVuY3Rpb24gX193cmFwcGVyXyR7bmFtZX0oKTogdm9pZCB7YCk7XG4gICAgaWYgKHBhcmFtcy5sZW5ndGggPiAwKSB7XG4gICAgICBmdW5jU291cmNlLnB1c2goXG4gICAgICAgIGAgIGNvbnN0IF9jbGFzcyA9IEpTT04ucGFyc2U8JHtjbGFzc05hbWV9PihnZXRJbnB1dFN0cmluZygpKWBcbiAgICAgICk7XG4gICAgfVxuICAgIGlmIChyZXR1cm5UeXBlTmFtZSAhPT0gXCJ2b2lkXCIpIHtcbiAgICAgIGlmIChwYXJhbXMubGVuZ3RoID4gMCkge1xuICAgICAgICBmdW5jU291cmNlLnB1c2goYGxldCByZXN1bHQ6ICR7cmV0dXJuVHlwZU5hbWV9ID0gX2NsYXNzLmNhbGwoKTtgKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGZ1bmNTb3VyY2UucHVzaChgbGV0IHJlc3VsdDogJHtyZXR1cm5UeXBlTmFtZX0gPSAke25hbWV9KCk7YCk7XG4gICAgICB9XG4gICAgICBmdW5jU291cmNlLnB1c2goYFxuICAgICAgY29uc3QgdmFsID0gU3RyaW5nLlVURjguZW5jb2RlKEpTT04uc3RyaW5naWZ5KHJlc3VsdCkpO1xuICAgICAgdmFsdWVfcmV0dXJuKHZhbC5ieXRlTGVuZ3RoLCBjaGFuZ2V0eXBlPHVzaXplPih2YWwpKTtcbiAgYCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmIChwYXJhbXMubGVuZ3RoID4gMCkge1xuICAgICAgICBmdW5jU291cmNlLnB1c2goYF9jbGFzcy5jYWxsKClgKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGZ1bmNTb3VyY2UucHVzaChgJHtuYW1lfSgpO2ApO1xuICAgICAgfVxuICAgIH1cbiAgICBmdW5jU291cmNlLnB1c2goYH1gKTtcbiAgICB0aGlzLmFkZEV4cG9ydChuYW1lKTtcbiAgICByZXR1cm4gZnVuY1NvdXJjZS5qb2luKFwiXFxuXCIpO1xuICB9XG5cbiAgYWRkRXhwb3J0KG5hbWU6IHN0cmluZyk6IHZvaWQge1xuICAgIHRoaXMuZXhwb3J0cy5wdXNoKGBleHBvcnQgeyR7V1JBUFBFUl9QUkVGSVggKyBuYW1lfSBhcyAke25hbWV9fWApO1xuICAgIGxldCByZXMgPSB0aGlzLmNhbWVsQ2FzZVRvU25ha2VDYXNlRXhwb3J0KG5hbWUsIFdSQVBQRVJfUFJFRklYKTtcbiAgICBpZiAocmVzKSB7XG4gICAgICB0aGlzLmV4cG9ydHMucHVzaChyZXMpO1xuICAgIH1cbiAgfVxuXG4gIHZpc2l0U291cmNlKG5vZGU6IFNvdXJjZSk6IHZvaWQge1xuICAgIHN1cGVyLnZpc2l0U291cmNlKG5vZGUpO1xuICAgIGNvbnN0IG5ld1BhcnNlciA9IG5ldyBQYXJzZXIoKTtcbiAgICBjb25zdCBsYXN0U3RhdGVtZW50ID1cbiAgICAgIChub2RlLnN0YXRlbWVudHMubGVuZ3RoICYmIG5vZGUuc3RhdGVtZW50c1tub2RlLnN0YXRlbWVudHMubGVuZ3RoIC0gMV0pIHx8XG4gICAgICBub2RlO1xuICAgIGlmICh0aGlzLmZ1bmN0aW9ucy5sZW5ndGggPiAwKSB7XG4gICAgICBub2RlLnN0YXRlbWVudHMucHVzaChcbiAgICAgICAgLi4udGhpcy5mdW5jdGlvbnMubWFwKChuKSA9PiBSYW5nZVRyYW5zZm9ybS52aXNpdChuLCBsYXN0U3RhdGVtZW50KSlcbiAgICAgICk7XG5cbiAgICAgIGNvbnN0IHN0ciA9IHRoaXMuZXhwb3J0cy5qb2luKFwiXFxuXCIpO1xuICAgICAgbmV3UGFyc2VyLnBhcnNlRmlsZShzdHIsIG5vZGUubm9ybWFsaXplZFBhdGgsIGlzRW50cnkobm9kZSkpO1xuICAgICAgY29uc3QgZXhwb3J0c1NvdXJjZSA9IG5ld1BhcnNlci5zb3VyY2VzWzBdO1xuICAgICAgbm9kZS5zdGF0ZW1lbnRzID0gbm9kZS5zdGF0ZW1lbnRzLmNvbmNhdChleHBvcnRzU291cmNlLnN0YXRlbWVudHMpO1xuICAgICAgbm9kZS5zdGF0ZW1lbnRzLnB1c2goLi4udGhpcy5jbGFzc1dyYXBwZXJzKTtcbiAgICB9XG4gIH1cblxuICBzdGF0aWMgdmlzaXQoc291cmNlczogU291cmNlW10pOiB2b2lkIHtcbiAgICBGdW5jdGlvbkV4cG9ydFdyYXBwZXIuY2hlY2tUZXN0QnVpbGQoc291cmNlcyk7XG4gICAgc291cmNlcy5mb3JFYWNoKChzKSA9PiB7XG4gICAgICBuZXcgRnVuY3Rpb25FeHBvcnRXcmFwcGVyKCkudmlzaXQocyk7XG4gICAgfSk7XG4gIH1cbn1cbiJdfQ==