"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.JSONTransformer = void 0;
const as_1 = require("visitor-as/as");
// import { JSONBindingsBuilder } from "./JSONBuilder";
const classExporter_1 = require("./classExporter");
const visitor_as_1 = require("visitor-as");
const path = require("path");
const common_1 = require("./common");
const functionWrapper_1 = require("./functionWrapper");
const methodInjector_1 = require("@serial-as/transform/dist/methodInjector");
const regex = /\/\/.*@nearfile .*out/;
class JSONTransformer extends as_1.Transform {
    parser;
    afterParse(parser) {
        this.parser = parser;
        const writeFile = this.writeFile;
        const baseDir = this.baseDir;
        // Filter for near files
        const sources = common_1.nearFiles(this.parser.sources);
        classExporter_1.ClassExporter.visit(sources);
        functionWrapper_1.FunctionExportWrapper.visit(sources);
        this.parser.sources.forEach(methodInjector_1.MethodInjector.visit);
        sources.forEach((source) => {
            if (regex.test(source.text))
                writeFile(path.join("out", source.normalizedPath), visitor_as_1.utils.toString(source), baseDir);
        });
        classExporter_1.ClassExporter.classSeen = null;
    }
}
exports.JSONTransformer = JSONTransformer;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJhbnNmb3JtZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvdHJhbnNmb3JtZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsc0NBQStFO0FBQy9FLHVEQUF1RDtBQUN2RCxtREFBZ0Q7QUFDaEQsMkNBQW1DO0FBQ25DLDZCQUE2QjtBQUM3QixxQ0FBcUM7QUFDckMsdURBQTBEO0FBQzFELDZFQUEwRTtBQUUxRSxNQUFNLEtBQUssR0FBRyx1QkFBdUIsQ0FBQztBQUN0QyxNQUFNLGVBQWdCLFNBQVEsY0FBUztJQUNyQyxNQUFNLENBQVM7SUFFZixVQUFVLENBQUMsTUFBYztRQUN2QixJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztRQUNyQixNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDO1FBQ2pDLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUM7UUFFN0Isd0JBQXdCO1FBQ3hCLE1BQU0sT0FBTyxHQUFHLGtCQUFTLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUMvQyw2QkFBYSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUM3Qix1Q0FBcUIsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDckMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLCtCQUFjLENBQUMsS0FBWSxDQUFDLENBQUM7UUFFekQsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDLE1BQU0sRUFBRSxFQUFFO1lBQ3pCLElBQUksS0FBSyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDO2dCQUN6QixTQUFTLENBQ1AsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsTUFBTSxDQUFDLGNBQWMsQ0FBQyxFQUN2QyxrQkFBSyxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsRUFDdEIsT0FBTyxDQUNSLENBQUM7UUFDTixDQUFDLENBQUMsQ0FBQztRQUVILDZCQUFhLENBQUMsU0FBUyxHQUFHLElBQUssQ0FBQztJQUNsQyxDQUFDO0NBQ0Y7QUFFUSwwQ0FBZSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFRyYW5zZm9ybSwgUGFyc2VyLCBQcm9ncmFtLCBNb2R1bGUsIFNvdXJjZUtpbmQgfSBmcm9tIFwidmlzaXRvci1hcy9hc1wiO1xuLy8gaW1wb3J0IHsgSlNPTkJpbmRpbmdzQnVpbGRlciB9IGZyb20gXCIuL0pTT05CdWlsZGVyXCI7XG5pbXBvcnQgeyBDbGFzc0V4cG9ydGVyIH0gZnJvbSBcIi4vY2xhc3NFeHBvcnRlclwiO1xuaW1wb3J0IHsgdXRpbHMgfSBmcm9tIFwidmlzaXRvci1hc1wiO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tIFwicGF0aFwiO1xuaW1wb3J0IHsgbmVhckZpbGVzIH0gZnJvbSBcIi4vY29tbW9uXCI7XG5pbXBvcnQgeyBGdW5jdGlvbkV4cG9ydFdyYXBwZXIgfSBmcm9tIFwiLi9mdW5jdGlvbldyYXBwZXJcIjtcbmltcG9ydCB7IE1ldGhvZEluamVjdG9yIH0gZnJvbSBcIkBzZXJpYWwtYXMvdHJhbnNmb3JtL2Rpc3QvbWV0aG9kSW5qZWN0b3JcIjtcblxuY29uc3QgcmVnZXggPSAvXFwvXFwvLipAbmVhcmZpbGUgLipvdXQvO1xuY2xhc3MgSlNPTlRyYW5zZm9ybWVyIGV4dGVuZHMgVHJhbnNmb3JtIHtcbiAgcGFyc2VyOiBQYXJzZXI7XG5cbiAgYWZ0ZXJQYXJzZShwYXJzZXI6IFBhcnNlcik6IHZvaWQge1xuICAgIHRoaXMucGFyc2VyID0gcGFyc2VyO1xuICAgIGNvbnN0IHdyaXRlRmlsZSA9IHRoaXMud3JpdGVGaWxlO1xuICAgIGNvbnN0IGJhc2VEaXIgPSB0aGlzLmJhc2VEaXI7XG5cbiAgICAvLyBGaWx0ZXIgZm9yIG5lYXIgZmlsZXNcbiAgICBjb25zdCBzb3VyY2VzID0gbmVhckZpbGVzKHRoaXMucGFyc2VyLnNvdXJjZXMpO1xuICAgIENsYXNzRXhwb3J0ZXIudmlzaXQoc291cmNlcyk7XG4gICAgRnVuY3Rpb25FeHBvcnRXcmFwcGVyLnZpc2l0KHNvdXJjZXMpO1xuICAgIHRoaXMucGFyc2VyLnNvdXJjZXMuZm9yRWFjaChNZXRob2RJbmplY3Rvci52aXNpdCBhcyBhbnkpO1xuICAgIFxuICAgIHNvdXJjZXMuZm9yRWFjaCgoc291cmNlKSA9PiB7XG4gICAgICBpZiAocmVnZXgudGVzdChzb3VyY2UudGV4dCkpXG4gICAgICAgIHdyaXRlRmlsZShcbiAgICAgICAgICBwYXRoLmpvaW4oXCJvdXRcIiwgc291cmNlLm5vcm1hbGl6ZWRQYXRoKSxcbiAgICAgICAgICB1dGlscy50b1N0cmluZyhzb3VyY2UpLFxuICAgICAgICAgIGJhc2VEaXJcbiAgICAgICAgKTtcbiAgICB9KTtcblxuICAgIENsYXNzRXhwb3J0ZXIuY2xhc3NTZWVuID0gbnVsbCE7XG4gIH1cbn1cblxuZXhwb3J0IHsgSlNPTlRyYW5zZm9ybWVyIH07XG4iXX0=