"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.JSONTransformer = void 0;
const as_1 = require("visitor-as/as");
// import { JSONBindingsBuilder } from "./JSONBuilder";
const classExporter_1 = require("./classExporter");
const visitor_as_1 = require("visitor-as");
const common_1 = require("./common");
const functionWrapper_1 = require("./functionWrapper");
const methodInjector_1 = require("@serial-as/transform/dist/methodInjector");
const utils_1 = require("./utils");
const regex = /\/\/.*@nearfile .*out/;
class JSONTransformer extends as_1.Transform {
    parser;
    afterParse(parser) {
        this.parser = parser;
        const writeFile = this.writeFile;
        const baseDir = this.baseDir;
        // Filter for near files
        const sources = common_1.nearFiles(this.parser.sources);
        classExporter_1.ClassExporter.visit(sources);
        functionWrapper_1.FunctionExportWrapper.visit(sources);
        this.parser.sources.forEach(methodInjector_1.MethodInjector.visit);
        sources.forEach((source) => {
            if (regex.test(source.text))
                writeFile(utils_1.posixRelativePath("out", source.normalizedPath), visitor_as_1.utils.toString(source), baseDir);
        });
        classExporter_1.ClassExporter.classSeen = null;
    }
}
exports.JSONTransformer = JSONTransformer;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJhbnNmb3JtZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvdHJhbnNmb3JtZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsc0NBQStFO0FBQy9FLHVEQUF1RDtBQUN2RCxtREFBZ0Q7QUFDaEQsMkNBQW1DO0FBRW5DLHFDQUFxQztBQUNyQyx1REFBMEQ7QUFDMUQsNkVBQTBFO0FBQzFFLG1DQUE0QztBQUU1QyxNQUFNLEtBQUssR0FBRyx1QkFBdUIsQ0FBQztBQUN0QyxNQUFNLGVBQWdCLFNBQVEsY0FBUztJQUNyQyxNQUFNLENBQVU7SUFFaEIsVUFBVSxDQUFDLE1BQWM7UUFDdkIsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7UUFDckIsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQztRQUNqQyxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDO1FBRTdCLHdCQUF3QjtRQUN4QixNQUFNLE9BQU8sR0FBRyxrQkFBUyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDL0MsNkJBQWEsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDN0IsdUNBQXFCLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ3JDLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQywrQkFBYyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBRWxELE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQyxNQUFNLEVBQUUsRUFBRTtZQUN6QixJQUFJLEtBQUssQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQztnQkFDekIsU0FBUyxDQUNQLHlCQUFpQixDQUFDLEtBQUssRUFBRSxNQUFNLENBQUMsY0FBYyxDQUFDLEVBQy9DLGtCQUFLLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxFQUN0QixPQUFPLENBQ1IsQ0FBQztRQUNOLENBQUMsQ0FBQyxDQUFDO1FBRUgsNkJBQWEsQ0FBQyxTQUFTLEdBQUcsSUFBSyxDQUFDO0lBQ2xDLENBQUM7Q0FDRjtBQUVRLDBDQUFlIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVHJhbnNmb3JtLCBQYXJzZXIsIFByb2dyYW0sIE1vZHVsZSwgU291cmNlS2luZCB9IGZyb20gXCJ2aXNpdG9yLWFzL2FzXCI7XG4vLyBpbXBvcnQgeyBKU09OQmluZGluZ3NCdWlsZGVyIH0gZnJvbSBcIi4vSlNPTkJ1aWxkZXJcIjtcbmltcG9ydCB7IENsYXNzRXhwb3J0ZXIgfSBmcm9tIFwiLi9jbGFzc0V4cG9ydGVyXCI7XG5pbXBvcnQgeyB1dGlscyB9IGZyb20gXCJ2aXNpdG9yLWFzXCI7XG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gXCJwYXRoXCI7XG5pbXBvcnQgeyBuZWFyRmlsZXMgfSBmcm9tIFwiLi9jb21tb25cIjtcbmltcG9ydCB7IEZ1bmN0aW9uRXhwb3J0V3JhcHBlciB9IGZyb20gXCIuL2Z1bmN0aW9uV3JhcHBlclwiO1xuaW1wb3J0IHsgTWV0aG9kSW5qZWN0b3IgfSBmcm9tIFwiQHNlcmlhbC1hcy90cmFuc2Zvcm0vZGlzdC9tZXRob2RJbmplY3RvclwiO1xuaW1wb3J0IHsgcG9zaXhSZWxhdGl2ZVBhdGggfSBmcm9tIFwiLi91dGlsc1wiO1xuXG5jb25zdCByZWdleCA9IC9cXC9cXC8uKkBuZWFyZmlsZSAuKm91dC87XG5jbGFzcyBKU09OVHJhbnNmb3JtZXIgZXh0ZW5kcyBUcmFuc2Zvcm0ge1xuICBwYXJzZXIhOiBQYXJzZXI7XG5cbiAgYWZ0ZXJQYXJzZShwYXJzZXI6IFBhcnNlcik6IHZvaWQge1xuICAgIHRoaXMucGFyc2VyID0gcGFyc2VyO1xuICAgIGNvbnN0IHdyaXRlRmlsZSA9IHRoaXMud3JpdGVGaWxlO1xuICAgIGNvbnN0IGJhc2VEaXIgPSB0aGlzLmJhc2VEaXI7XG5cbiAgICAvLyBGaWx0ZXIgZm9yIG5lYXIgZmlsZXNcbiAgICBjb25zdCBzb3VyY2VzID0gbmVhckZpbGVzKHRoaXMucGFyc2VyLnNvdXJjZXMpO1xuICAgIENsYXNzRXhwb3J0ZXIudmlzaXQoc291cmNlcyk7XG4gICAgRnVuY3Rpb25FeHBvcnRXcmFwcGVyLnZpc2l0KHNvdXJjZXMpO1xuICAgIHRoaXMucGFyc2VyLnNvdXJjZXMuZm9yRWFjaChNZXRob2RJbmplY3Rvci52aXNpdCk7XG5cbiAgICBzb3VyY2VzLmZvckVhY2goKHNvdXJjZSkgPT4ge1xuICAgICAgaWYgKHJlZ2V4LnRlc3Qoc291cmNlLnRleHQpKVxuICAgICAgICB3cml0ZUZpbGUoXG4gICAgICAgICAgcG9zaXhSZWxhdGl2ZVBhdGgoXCJvdXRcIiwgc291cmNlLm5vcm1hbGl6ZWRQYXRoKSxcbiAgICAgICAgICB1dGlscy50b1N0cmluZyhzb3VyY2UpLFxuICAgICAgICAgIGJhc2VEaXJcbiAgICAgICAgKTtcbiAgICB9KTtcblxuICAgIENsYXNzRXhwb3J0ZXIuY2xhc3NTZWVuID0gbnVsbCE7XG4gIH1cbn1cblxuZXhwb3J0IHsgSlNPTlRyYW5zZm9ybWVyIH07XG4iXX0=